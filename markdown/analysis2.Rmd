---
title: "analysis2"
output:
  html_document:
    df_print: paged
---

```{r setup, include=FALSE, echo=FALSE, warning=FALSE, message=FALSE}
knitr::opts_chunk$set(echo = FALSE, warning = FALSE, message = FALSE)
```


```{r}

library(sf)
library(parlitools)
library(here)
library(ggfortify)
library(patchwork)
library(stringr)
library(here)
library(GGally)
library(spatialreg)
library(spdep)
library(broom)
library(spgwr)
library(gridExtra)
library(grid)
library(Hmisc)
library(MASS)
library(stargazer)
library(car)
library(factoextra)
library(GWmodel)
library(sjPlot)
library(sjmisc)
library(sjlabelled)
library(ggpubr)
library(RColorBrewer)
library(tidyverse)

rm(list=ls())
here()
```

### Conservative Change Variable = 
### Log Odds of Ratio of Proportion Cons/Not Cons2019 to Proportion Cons/Not Cons2017

```{r}
# read in required data

all_elections <- readRDS(here("data", "all_elections.rds"))
party_colour <- party_colour
constituency_polygons <- readRDS(here("data", "constituency_polygons.rds"))

#################################
# focus on change in votes
# map this for different parties

all_elections <- all_elections %>% 
  mutate(competed_con = factor(ifelse(is.na(con_19-con_17),"No","Yes")),
         competed_lab = factor(ifelse(is.na(lab_19-lab_17),"No","Yes")),
         competed_ld = factor(ifelse(is.na(ld_19-ld_17),"No","Yes")),
         competed_green = factor(ifelse(is.na(green_19-green_17),"No","Yes")),
         competed_pc = factor(ifelse(is.na(pc_19-pc_17),"No","Yes")),
         competed_snp = factor(ifelse(is.na(snp_19-snp_17),"No","Yes")),)



# since SNP completely dominant in Scotland, but does not run elsewhere
# will treat England & Wales as one dataset "all_elections1"
# Scotland will be "all_elections2"
# examine each separately

# focus on change in conservative vote in England and Wales
# will add variable for change in conservative vote 2017-19: "con_change"

all_elections <- all_elections %>% 
  mutate(
    con_change = log(
      (con_19/(1-con_19)) / (con_17/(1-con_17))
    ), 
    con_change17 = log(
      (con_17/(1-con_17)) / (con_15/(1-con_15))
    ), 
    marginality = ifelse(winner_17=="Conservative", majority_17,
                         ifelse(winner_17=="Labour", con_17-lab_17, 
                                ifelse(winner_17=="Liberal Democrat", con_17-ld_17, 
                                     ifelse(winner_17=="Green", con_17-green_17, con_17-pc_17)
                                )))
    ) %>% 
  filter(!is.na(con_change)) %>%  # where didn't compete, speaker's seat
  filter(!is.na(marginality))
all_elections1 <- all_elections %>% 
  filter(country != "Scotland")
all_elections2 <- all_elections %>% 
  filter(country == "Scotland")


```

```{r}
# select variables

# extract the variables or combination variables which have been chosen...

all_elections1 <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density)
vars <- all_elections1 %>% 
  dplyr::select(con_change, low_qual, over65, deprived, student, marginality) %>% 
  st_drop_geometry()
```

 
```{r}

all_elections_polygons <- left_join(all_elections1 %>% st_drop_geometry(), 
                            constituency_polygons, by = c("ons_const_id" = "pcon19cd")) %>% 
  st_as_sf() %>% 
  st_simplify(dTolerance = 1000)

coords <- st_centroid(all_elections_polygons$geometry) %>%
  st_coordinates()

```

### GWR of GW PCA components (local components) 


```{r}

# first, perform the GWPCA
spdf <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density) %>%
  dplyr::select(low_qual, over65, student, deprived, density, leave_EU, health_very_bad, house_owned, household_one_person,
                ethnicity_white, unemployed, born_elsewhere, marginality, geometry) %>%
  as_Spatial()


pca.gw <- gwpca(spdf, vars=colnames(spdf@data), bw=10, k=2) # first 2 pcomps

loadings <- pca.gw$loadings # first and second components 

```

### Coefficient value in each constituency

```{r, fig.height=12, fig.width=12}

spdf <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density) %>%
  dplyr::select(low_qual, over65, student, deprived, density, leave_EU, health_very_bad, house_owned, household_one_person,
                ethnicity_white, unemployed, born_elsewhere, marginality) %>% 
  st_drop_geometry()

spdf.scaled <- scale(as.matrix(spdf))

d1s <- SpatialPointsDataFrame(coords,as.data.frame(spdf.scaled))
pca.gw <- gwpca(d1s,vars=colnames(d1s@data),bw=1000000,k=2,scores = TRUE)

loadings <- pca.gw$loadings

pca.gw$gwpca.scores <- as.data.frame(pca.gw$gwpca.scores)
PC1gw <- as.data.frame(pca.gw$gwpca.scores[,2])
PC2gw <- as.data.frame(pca.gw$gwpca.scores[,3])



pcagw.df <- as.data.frame(cbind(all_elections1$con_change, PC1gw, PC2gw, all_elections_polygons$geometry)) %>% 
  st_as_sf()
colnames(pcagw.df) <- c("con_change", "PC1gw", "PC2gw", "geometry")
str(pcagw.df)

# now the GWR model with GWPCA components
GWRbandwidth.gwpca <- gwr.sel(con_change ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, adapt=T)

GWRbandwidth.gwpca

#run the gwr model
gwr.model.gwpca = gwr(con_change ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, 
                adapt=GWRbandwidth.gwpca, hatmatrix=TRUE, se.fit=TRUE) 


# examine first two components
head(gwr.model.gwpca$SDF$PC1gw)
head(gwr.model.gwpca$SDF$PC2gw)

# before loop, define vectors
coef_low_qual_gwpca <- vector()
coef_over65_gwpca <- vector()
coef_student_gwpca <- vector()
coef_deprived_gwpca <- vector()
coef_density_gwpca <- vector()
coef_leave_EU_gwpca <- vector()
coef_health_very_bad_gwpca <- vector()
coef_house_owned_gwpca <- vector()
coef_household_one_person_gwpca <- vector()
coef_ethnicity_white_gwpca <- vector()
coef_unemployed_gwpca <- vector()
coef_born_elsewhere_gwpca <- vector()
coef_marg_gwpca <- vector()

# calculate coefficient for each variable by same technique as before
for (i in 1:571) {
coef_low_qual_gwpca[i] <- as.vector((loadings[i,1,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,1,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_over65_gwpca[i] <- as.vector((loadings[i,2,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,2,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_student_gwpca[i] <- as.vector((loadings[i,3,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,3,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_deprived_gwpca[i] <- as.vector((loadings[i,4,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,4,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_density_gwpca[i] <- as.vector((loadings[i,5,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,5,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_leave_EU_gwpca[i] <- as.vector((loadings[i,6,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,6,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_health_very_bad_gwpca[i] <- as.vector((loadings[i,7,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,7,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_house_owned_gwpca[i] <- as.vector((loadings[i,8,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,8,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_household_one_person_gwpca[i] <- as.vector((loadings[i,9,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,9,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_ethnicity_white_gwpca[i] <- as.vector((loadings[i,10,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,10,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_unemployed_gwpca[i] <- as.vector((loadings[i,11,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,11,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_born_elsewhere_gwpca[i] <- as.vector((loadings[i,12,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,12,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_marg_gwpca[i] <- as.vector((loadings[i,13,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,13,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
}

# bind into a table
gwr_gwpca_table <- as.data.frame(cbind(coef_low_qual_gwpca, coef_over65_gwpca, coef_student_gwpca, coef_deprived_gwpca,
               coef_density_gwpca, coef_leave_EU_gwpca, coef_health_very_bad_gwpca, coef_house_owned_gwpca, 
               coef_household_one_person_gwpca, coef_ethnicity_white_gwpca, 
               coef_unemployed_gwpca, coef_born_elsewhere_gwpca, coef_marg_gwpca)) %>% 
  apply(2,exp)


# insert into all_elections1 with polygons
all_elections1 <- cbind(all_elections1, gwr_gwpca_table) %>% 
  st_drop_geometry() %>% 
  cbind(all_elections_polygons$geometry) %>% 
  st_as_sf()
  

```


```{r, fig.height=6, fig.width=12}


# coefficient value in each consitituency

p_low_qual_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_low_qual_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_over65_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_over65_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_student_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_student_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_deprived_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_deprived_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_density_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_density_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_leave_EU_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_leave_EU_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_health_very_bad_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_health_very_bad_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_house_owned_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_house_owned_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_household_one_person_19change <- ggplot(all_elections1) + 
  geom_sf(aes(fill=coef_household_one_person_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_ethnicity_white_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_ethnicity_white_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_unemployed_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_unemployed_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_born_elsewhere_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_born_elsewhere_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_marg_19change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_marg_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)



```

### Get Pseudo t-Values and significance levels

```{r}

# first run gwr.basic model
# then use gwr.t.adjust
pcagw.df <- as_Spatial(pcagw.df)
DM<-gw.dist(coords)
bw2<-bw.gwr(con_change ~ PC1gw + PC2gw, 
                        data=pcagw.df,approach="aic",adaptive=TRUE, 
kernel = "gaussian", dMat=DM)
gwr.res2<-gwr.basic(con_change ~ PC1gw + PC2gw, 
                        data=pcagw.df, bw=bw2,adaptive=TRUE,
kernel = "gaussian", dMat=DM)

x <- gwr.t.adjust(gwr.res2)
all_elections_tvals <- all_elections1 %>% 
  cbind(x$results$p) %>% 
  mutate(
    PC1p95 = factor (ifelse (PC1gw_p <= 0.05, 0.05, 1)),
    PC2p95 = factor (ifelse (PC2gw_p <= 0.05, 0.05, 1)),
    PC1p90 = factor (ifelse (PC1gw_p >0.05 & PC1gw_p <0.1, 0.1, 1)),
    PC2p90 = factor (ifelse (PC2gw_p >0.05 & PC2gw_p <0.1, 0.1, 1)),
    PCsig = factor (ifelse (PC1p95==PC2p95, 0.05, 
                           ifelse(PC1p90==PC2p90, 0.1, "N/S"))))
         

ggplot(all_elections_tvals) + geom_sf(aes(fill=PCsig)) + 
  scale_fill_manual(values = c("red","pink","black")) +
  labs(title = "Significance of Coefficient Estimates",
       fill = "p-value")


```



#### R-squared

```{r, fig.height=6, fig.width=12}

r2.gwr.gwpca <- as.data.frame(gwr.model.gwpca$SDF$localR2) %>% 
  cbind(all_elections_polygons) %>% 
  st_as_sf()


ggplot(r2.gwr.gwpca) + geom_sf(aes(fill=`gwr.model.gwpca$SDF$localR2`)) +
  coord_sf(datum = NA) +  
  theme_light() +
  scale_fill_steps2() + 
  labs(title = "R2 GWR local PCA", 
       fill = "R-squared Value")

```


### Election 2017 vs 2015


```{r}
all_elections <- all_elections %>% 
  mutate(
    con_change = log(
      (con_19/(1-con_19)) / (con_17/(1-con_17))
    ), 
    con_change17 = log(
      (con_17/(1-con_17)) / (con_15/(1-con_15))
    ), 
    marginality = ifelse(winner_17=="Conservative", majority_17,
                         ifelse(winner_17=="Labour", con_17-lab_17, 
                                ifelse(winner_17=="Liberal Democrat", con_17-ld_17, 
                                     ifelse(winner_17=="Green", con_17-green_17, con_17-pc_17)
                                )))
    ) %>% 
  filter(!is.na(con_change)) %>%  # where didn't compete, speaker's seat
  filter(!is.na(marginality))
all_elections1 <- all_elections %>% 
  filter(country != "Scotland")
all_elections2 <- all_elections %>% 
  filter(country == "Scotland")


```

```{r}
# select variables

# extract the variables or combination variables which have been chosen...

all_elections1 <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density)
vars <- all_elections1 %>% 
  dplyr::select(con_change17, low_qual, over65, deprived, student, marginality) %>% 
  st_drop_geometry()
```

 
```{r}

all_elections_polygons <- left_join(all_elections1 %>% st_drop_geometry(), 
                            constituency_polygons, by = c("ons_const_id" = "pcon19cd")) %>% 
  st_as_sf() %>% 
  st_simplify(dTolerance = 1000)

coords <- st_centroid(all_elections_polygons$geometry) %>%
  st_coordinates()

```

```{r}

pcagw.df <- as.data.frame(cbind(all_elections1$con_change17, PC1gw, PC2gw, all_elections_polygons$geometry)) %>% 
  st_as_sf()
colnames(pcagw.df) <- c("con_change17", "PC1gw", "PC2gw", "geometry")
str(pcagw.df)

# now the GWR model with GWPCA components
GWRbandwidth.gwpca <- gwr.sel(con_change17 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, adapt=T)

GWRbandwidth.gwpca

#run the gwr model
gwr.model.gwpca = gwr(con_change17 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, 
                adapt=GWRbandwidth.gwpca, hatmatrix=TRUE, se.fit=TRUE) 

# examine first two components
head(gwr.model.gwpca$SDF$PC1gw)
head(gwr.model.gwpca$SDF$PC2gw)

# before loop, define vectors
coef_low_qual_gwpca <- vector()
coef_over65_gwpca <- vector()
coef_student_gwpca <- vector()
coef_deprived_gwpca <- vector()
coef_density_gwpca <- vector()
coef_leave_EU_gwpca <- vector()
coef_health_very_bad_gwpca <- vector()
coef_house_owned_gwpca <- vector()
coef_household_one_person_gwpca <- vector()
coef_ethnicity_white_gwpca <- vector()
coef_unemployed_gwpca <- vector()
coef_born_elsewhere_gwpca <- vector()
coef_marg_gwpca <- vector()

# calculate coefficient for each variable by same technique as before
for (i in 1:571) {
coef_low_qual_gwpca[i] <- as.vector((loadings[i,1,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,1,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_over65_gwpca[i] <- as.vector((loadings[i,2,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,2,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_student_gwpca[i] <- as.vector((loadings[i,3,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,3,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_deprived_gwpca[i] <- as.vector((loadings[i,4,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,4,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_density_gwpca[i] <- as.vector((loadings[i,5,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,5,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_leave_EU_gwpca[i] <- as.vector((loadings[i,6,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,6,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_health_very_bad_gwpca[i] <- as.vector((loadings[i,7,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,7,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_house_owned_gwpca[i] <- as.vector((loadings[i,8,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,8,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_household_one_person_gwpca[i] <- as.vector((loadings[i,9,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,9,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_ethnicity_white_gwpca[i] <- as.vector((loadings[i,10,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,10,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_unemployed_gwpca[i] <- as.vector((loadings[i,11,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,11,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_born_elsewhere_gwpca[i] <- as.vector((loadings[i,12,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,12,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_marg_gwpca[i] <- as.vector((loadings[i,13,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,13,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
}

# bind into a table
gwr_gwpca_table <- as.data.frame(cbind(coef_low_qual_gwpca, coef_over65_gwpca, coef_student_gwpca, coef_deprived_gwpca,
               coef_density_gwpca, coef_leave_EU_gwpca, coef_health_very_bad_gwpca, coef_house_owned_gwpca, 
               coef_household_one_person_gwpca, coef_ethnicity_white_gwpca, 
               coef_unemployed_gwpca, coef_born_elsewhere_gwpca, coef_marg_gwpca)) %>% 
  apply(2,exp)


# insert into all_elections1 with polygons
all_elections1 <- cbind(all_elections1, gwr_gwpca_table) %>% 
  st_drop_geometry() %>% 
  cbind(all_elections_polygons$geometry) %>% 
  st_as_sf()
  

```


```{r, fig.height=6, fig.width=12}


# coefficient value in each consitituency

p_low_qual_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_low_qual_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_over65_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_over65_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_student_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_student_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_deprived_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_deprived_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_density_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_density_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_leave_EU_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_leave_EU_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_health_very_bad_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_health_very_bad_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_house_owned_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_house_owned_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_household_one_person_17change <- ggplot(all_elections1) + 
  geom_sf(aes(fill=coef_household_one_person_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_ethnicity_white_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_ethnicity_white_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_unemployed_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_unemployed_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_born_elsewhere_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_born_elsewhere_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_marg_17change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_marg_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)


```


### Election 2015 vs 2010


```{r}
all_elections <- all_elections %>% 
  mutate(
    con_change = log(
      (con_19/(1-con_19)) / (con_17/(1-con_17))
    ), 
    con_change15 = log(
      (con_15/(1-con_15)) / (con_10/(1-con_10))
    ), 
    marginality = ifelse(winner_17=="Conservative", majority_17,
                         ifelse(winner_17=="Labour", con_17-lab_17, 
                                ifelse(winner_17=="Liberal Democrat", con_17-ld_17, 
                                     ifelse(winner_17=="Green", con_17-green_17, con_17-pc_17)
                                )))
    ) %>% 
  filter(!is.na(con_change)) %>%  # where didn't compete, speaker's seat
  filter(!is.na(marginality))
all_elections1 <- all_elections %>% 
  filter(country != "Scotland")
all_elections2 <- all_elections %>% 
  filter(country == "Scotland")


```

```{r}
# select variables

# extract the variables or combination variables which have been chosen...

all_elections1 <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density)
vars <- all_elections1 %>% 
  dplyr::select(con_change15, low_qual, over65, deprived, student, marginality) %>% 
  st_drop_geometry()
```

 
```{r}

all_elections_polygons <- left_join(all_elections1 %>% st_drop_geometry(), 
                            constituency_polygons, by = c("ons_const_id" = "pcon19cd")) %>% 
  st_as_sf() %>% 
  st_simplify(dTolerance = 1000)

coords <- st_centroid(all_elections_polygons$geometry) %>%
  st_coordinates()

```

```{r}

pcagw.df <- as.data.frame(cbind(all_elections1$con_change15, PC1gw, PC2gw, all_elections_polygons$geometry)) %>% 
  st_as_sf()
colnames(pcagw.df) <- c("con_change15", "PC1gw", "PC2gw", "geometry")
str(pcagw.df)

# now the GWR model with GWPCA components
GWRbandwidth.gwpca <- gwr.sel(con_change15 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, adapt=T)

GWRbandwidth.gwpca

#run the gwr model
gwr.model.gwpca = gwr(con_change15 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, 
                adapt=GWRbandwidth.gwpca, hatmatrix=TRUE, se.fit=TRUE) 

# examine first two components
head(gwr.model.gwpca$SDF$PC1gw)
head(gwr.model.gwpca$SDF$PC2gw)

# before loop, define vectors
coef_low_qual_gwpca <- vector()
coef_over65_gwpca <- vector()
coef_student_gwpca <- vector()
coef_deprived_gwpca <- vector()
coef_density_gwpca <- vector()
coef_leave_EU_gwpca <- vector()
coef_health_very_bad_gwpca <- vector()
coef_house_owned_gwpca <- vector()
coef_household_one_person_gwpca <- vector()
coef_ethnicity_white_gwpca <- vector()
coef_unemployed_gwpca <- vector()
coef_born_elsewhere_gwpca <- vector()
coef_marg_gwpca <- vector()

# calculate coefficient for each variable by same technique as before
for (i in 1:571) {
coef_low_qual_gwpca[i] <- as.vector((loadings[i,1,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,1,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_over65_gwpca[i] <- as.vector((loadings[i,2,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,2,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_student_gwpca[i] <- as.vector((loadings[i,3,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,3,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_deprived_gwpca[i] <- as.vector((loadings[i,4,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,4,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_density_gwpca[i] <- as.vector((loadings[i,5,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,5,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_leave_EU_gwpca[i] <- as.vector((loadings[i,6,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,6,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_health_very_bad_gwpca[i] <- as.vector((loadings[i,7,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,7,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_house_owned_gwpca[i] <- as.vector((loadings[i,8,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,8,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_household_one_person_gwpca[i] <- as.vector((loadings[i,9,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,9,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_ethnicity_white_gwpca[i] <- as.vector((loadings[i,10,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,10,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_unemployed_gwpca[i] <- as.vector((loadings[i,11,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,11,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_born_elsewhere_gwpca[i] <- as.vector((loadings[i,12,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,12,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_marg_gwpca[i] <- as.vector((loadings[i,13,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,13,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
}

# bind into a table
gwr_gwpca_table <- as.data.frame(cbind(coef_low_qual_gwpca, coef_over65_gwpca, coef_student_gwpca, coef_deprived_gwpca,
               coef_density_gwpca, coef_leave_EU_gwpca, coef_health_very_bad_gwpca, coef_house_owned_gwpca, 
               coef_household_one_person_gwpca, coef_ethnicity_white_gwpca, 
               coef_unemployed_gwpca, coef_born_elsewhere_gwpca, coef_marg_gwpca)) %>% 
  apply(2,exp)


# insert into all_elections1 with polygons
all_elections1 <- cbind(all_elections1, gwr_gwpca_table) %>% 
  st_drop_geometry() %>% 
  cbind(all_elections_polygons$geometry) %>% 
  st_as_sf()
  

```



```{r, fig.height=6, fig.width=12}

# coefficient value in each consitituency

p_low_qual_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_low_qual_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_over65_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_over65_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_student_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_student_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_deprived_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_deprived_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_density_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_density_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_leave_EU_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_leave_EU_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_health_very_bad_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_health_very_bad_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_house_owned_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_house_owned_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_household_one_person_15change <- ggplot(all_elections1) + 
  geom_sf(aes(fill=coef_household_one_person_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_ethnicity_white_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_ethnicity_white_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_unemployed_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_unemployed_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_born_elsewhere_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_born_elsewhere_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)

p_marg_15change <- ggplot(all_elections1) + geom_sf(aes(fill=coef_marg_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 1)


```

### Election 2019 cons vote %, not change


```{r}
all_elections <- all_elections %>% 
  mutate(
    con_change = log(
      (con_19/(1-con_19)) / (con_17/(1-con_17))
    ), 
    con_change15 = log(
      (con_15/(1-con_15)) / (con_10/(1-con_10))
    ), 
    marginality = ifelse(winner_17=="Conservative", majority_17,
                         ifelse(winner_17=="Labour", con_17-lab_17, 
                                ifelse(winner_17=="Liberal Democrat", con_17-ld_17, 
                                     ifelse(winner_17=="Green", con_17-green_17, con_17-pc_17)
                                )))
    ) %>% 
  filter(!is.na(con_change)) %>%  # where didn't compete, speaker's seat
  filter(!is.na(marginality))
all_elections1 <- all_elections %>% 
  filter(country != "Scotland")
all_elections2 <- all_elections %>% 
  filter(country == "Scotland")


```

```{r}
# select variables

# extract the variables or combination variables which have been chosen...

all_elections1 <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density)
vars <- all_elections1 %>% 
  dplyr::select(con_19, low_qual, over65, deprived, student, marginality) %>% 
  st_drop_geometry()
```

 
```{r}

all_elections_polygons <- left_join(all_elections1 %>% st_drop_geometry(), 
                            constituency_polygons, by = c("ons_const_id" = "pcon19cd")) %>% 
  st_as_sf() %>% 
  st_simplify(dTolerance = 1000)

coords <- st_centroid(all_elections_polygons$geometry) %>%
  st_coordinates()

```

```{r}

pcagw.df <- as.data.frame(cbind(all_elections1$con_19, PC1gw, PC2gw, all_elections_polygons$geometry)) %>% 
  st_as_sf()
colnames(pcagw.df) <- c("con_19", "PC1gw", "PC2gw", "geometry")
str(pcagw.df)

# now the GWR model with GWPCA components
GWRbandwidth.gwpca <- gwr.sel(con_19 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, adapt=T)

GWRbandwidth.gwpca

#run the gwr model
gwr.model.gwpca = gwr(con_19 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, 
                adapt=GWRbandwidth.gwpca, hatmatrix=TRUE, se.fit=TRUE) 

# examine first two components
head(gwr.model.gwpca$SDF$PC1gw)
head(gwr.model.gwpca$SDF$PC2gw)

# before loop, define vectors
coef_low_qual_gwpca <- vector()
coef_over65_gwpca <- vector()
coef_student_gwpca <- vector()
coef_deprived_gwpca <- vector()
coef_density_gwpca <- vector()
coef_leave_EU_gwpca <- vector()
coef_health_very_bad_gwpca <- vector()
coef_house_owned_gwpca <- vector()
coef_household_one_person_gwpca <- vector()
coef_ethnicity_white_gwpca <- vector()
coef_unemployed_gwpca <- vector()
coef_born_elsewhere_gwpca <- vector()
coef_marg_gwpca <- vector()

# calculate coefficient for each variable by same technique as before
for (i in 1:571) {
coef_low_qual_gwpca[i] <- as.vector((loadings[i,1,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,1,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_over65_gwpca[i] <- as.vector((loadings[i,2,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,2,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_student_gwpca[i] <- as.vector((loadings[i,3,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,3,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_deprived_gwpca[i] <- as.vector((loadings[i,4,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,4,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_density_gwpca[i] <- as.vector((loadings[i,5,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,5,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_leave_EU_gwpca[i] <- as.vector((loadings[i,6,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,6,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_health_very_bad_gwpca[i] <- as.vector((loadings[i,7,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,7,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_house_owned_gwpca[i] <- as.vector((loadings[i,8,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,8,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_household_one_person_gwpca[i] <- as.vector((loadings[i,9,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,9,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_ethnicity_white_gwpca[i] <- as.vector((loadings[i,10,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,10,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_unemployed_gwpca[i] <- as.vector((loadings[i,11,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,11,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_born_elsewhere_gwpca[i] <- as.vector((loadings[i,12,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,12,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_marg_gwpca[i] <- as.vector((loadings[i,13,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,13,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
}

# bind into a table
gwr_gwpca_table <- as.data.frame(cbind(coef_low_qual_gwpca, coef_over65_gwpca, coef_student_gwpca, coef_deprived_gwpca,
               coef_density_gwpca, coef_leave_EU_gwpca, coef_health_very_bad_gwpca, coef_house_owned_gwpca, 
               coef_household_one_person_gwpca, coef_ethnicity_white_gwpca, 
               coef_unemployed_gwpca, coef_born_elsewhere_gwpca, coef_marg_gwpca))

# insert into all_elections1 with polygons
all_elections1 <- cbind(all_elections1, gwr_gwpca_table) %>% 
  st_drop_geometry() %>% 
  cbind(all_elections_polygons$geometry) %>% 
  st_as_sf()
  

```


```{r, fig.height=6, fig.width=12}


# coefficient value in each consitituency

p_low_qual_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_low_qual_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_over65_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_over65_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_student_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_student_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_deprived_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_deprived_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_density_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_density_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_leave_EU_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_leave_EU_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_health_very_bad_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_health_very_bad_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_house_owned_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_house_owned_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_household_one_person_19tot <- ggplot(all_elections1) + 
  geom_sf(aes(fill=coef_household_one_person_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_ethnicity_white_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_ethnicity_white_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_unemployed_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_unemployed_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_born_elsewhere_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_born_elsewhere_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_marg_19tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_marg_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)


```

### Election 2017 cons vote %, not change


```{r}
all_elections <- all_elections %>% 
  mutate(
    con_change = log(
      (con_19/(1-con_19)) / (con_17/(1-con_17))
    ), 
    con_change15 = log(
      (con_15/(1-con_15)) / (con_10/(1-con_10))
    ), 
    marginality = ifelse(winner_17=="Conservative", majority_17,
                         ifelse(winner_17=="Labour", con_17-lab_17, 
                                ifelse(winner_17=="Liberal Democrat", con_17-ld_17, 
                                     ifelse(winner_17=="Green", con_17-green_17, con_17-pc_17)
                                )))
    ) %>% 
  filter(!is.na(con_change)) %>%  # where didn't compete, speaker's seat
  filter(!is.na(marginality))
all_elections1 <- all_elections %>% 
  filter(country != "Scotland")
all_elections2 <- all_elections %>% 
  filter(country == "Scotland")


```

```{r}
# select variables

# extract the variables or combination variables which have been chosen...

all_elections1 <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density)
vars <- all_elections1 %>% 
  dplyr::select(con_17, low_qual, over65, deprived, student, marginality) %>% 
  st_drop_geometry()
```

 
```{r}

all_elections_polygons <- left_join(all_elections1 %>% st_drop_geometry(), 
                            constituency_polygons, by = c("ons_const_id" = "pcon19cd")) %>% 
  st_as_sf() %>% 
  st_simplify(dTolerance = 1000)

coords <- st_centroid(all_elections_polygons$geometry) %>%
  st_coordinates()

```

```{r}

pcagw.df <- as.data.frame(cbind(all_elections1$con_17, PC1gw, PC2gw, all_elections_polygons$geometry)) %>% 
  st_as_sf()
colnames(pcagw.df) <- c("con_17", "PC1gw", "PC2gw", "geometry")
str(pcagw.df)

# now the GWR model with GWPCA components
GWRbandwidth.gwpca <- gwr.sel(con_17 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, adapt=T)

GWRbandwidth.gwpca

#run the gwr model
gwr.model.gwpca = gwr(con_17 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, 
                adapt=GWRbandwidth.gwpca, hatmatrix=TRUE, se.fit=TRUE) 

# examine first two components
head(gwr.model.gwpca$SDF$PC1gw)
head(gwr.model.gwpca$SDF$PC2gw)

# before loop, define vectors
coef_low_qual_gwpca <- vector()
coef_over65_gwpca <- vector()
coef_student_gwpca <- vector()
coef_deprived_gwpca <- vector()
coef_density_gwpca <- vector()
coef_leave_EU_gwpca <- vector()
coef_health_very_bad_gwpca <- vector()
coef_house_owned_gwpca <- vector()
coef_household_one_person_gwpca <- vector()
coef_ethnicity_white_gwpca <- vector()
coef_unemployed_gwpca <- vector()
coef_born_elsewhere_gwpca <- vector()
coef_marg_gwpca <- vector()

# calculate coefficient for each variable by same technique as before
for (i in 1:571) {
coef_low_qual_gwpca[i] <- as.vector((loadings[i,1,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,1,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_over65_gwpca[i] <- as.vector((loadings[i,2,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,2,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_student_gwpca[i] <- as.vector((loadings[i,3,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,3,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_deprived_gwpca[i] <- as.vector((loadings[i,4,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,4,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_density_gwpca[i] <- as.vector((loadings[i,5,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,5,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_leave_EU_gwpca[i] <- as.vector((loadings[i,6,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,6,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_health_very_bad_gwpca[i] <- as.vector((loadings[i,7,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,7,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_house_owned_gwpca[i] <- as.vector((loadings[i,8,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,8,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_household_one_person_gwpca[i] <- as.vector((loadings[i,9,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,9,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_ethnicity_white_gwpca[i] <- as.vector((loadings[i,10,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,10,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_unemployed_gwpca[i] <- as.vector((loadings[i,11,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,11,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_born_elsewhere_gwpca[i] <- as.vector((loadings[i,12,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,12,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_marg_gwpca[i] <- as.vector((loadings[i,13,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,13,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
}

# bind into a table
gwr_gwpca_table <- as.data.frame(cbind(coef_low_qual_gwpca, coef_over65_gwpca, coef_student_gwpca, coef_deprived_gwpca,
               coef_density_gwpca, coef_leave_EU_gwpca, coef_health_very_bad_gwpca, coef_house_owned_gwpca, 
               coef_household_one_person_gwpca, coef_ethnicity_white_gwpca, 
               coef_unemployed_gwpca, coef_born_elsewhere_gwpca, coef_marg_gwpca))

# insert into all_elections1 with polygons
all_elections1 <- cbind(all_elections1, gwr_gwpca_table) %>% 
  st_drop_geometry() %>% 
  cbind(all_elections_polygons$geometry) %>% 
  st_as_sf()
  

```


```{r, fig.height=6, fig.width=12}


# coefficient value in each consitituency

p_low_qual_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_low_qual_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_over65_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_over65_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_student_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_student_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_deprived_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_deprived_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_density_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_density_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_leave_EU_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_leave_EU_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_health_very_bad_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_health_very_bad_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_house_owned_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_house_owned_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_household_one_person_17tot <- ggplot(all_elections1) + 
  geom_sf(aes(fill=coef_household_one_person_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_ethnicity_white_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_ethnicity_white_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_unemployed_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_unemployed_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_born_elsewhere_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_born_elsewhere_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_marg_17tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_marg_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)


```


### Election 2015 cons vote %, not change


```{r}
all_elections <- all_elections %>% 
  mutate(
    con_change = log(
      (con_19/(1-con_19)) / (con_17/(1-con_17))
    ), 
    con_change15 = log(
      (con_15/(1-con_15)) / (con_10/(1-con_10))
    ), 
    marginality = ifelse(winner_17=="Conservative", majority_17,
                         ifelse(winner_17=="Labour", con_17-lab_17, 
                                ifelse(winner_17=="Liberal Democrat", con_17-ld_17, 
                                     ifelse(winner_17=="Green", con_17-green_17, con_17-pc_17)
                                )))
    ) %>% 
  filter(!is.na(con_change)) %>%  # where didn't compete, speaker's seat
  filter(!is.na(marginality))
all_elections1 <- all_elections %>% 
  filter(country != "Scotland")
all_elections2 <- all_elections %>% 
  filter(country == "Scotland")


```

```{r}
# select variables

# extract the variables or combination variables which have been chosen...

all_elections1 <- all_elections1 %>%
  mutate(over65 = age_65_to_74 + age_75_to_84 + age_85_to_89 + age_90_plus,
         low_qual = qual_none + qual_level_1,
         deprived = deprived_2 + deprived_3 + deprived_4,
         student = economically_inactive_student,
         leave_EU = leave_hanretty,
         density = population_density,
         born_elsewhere = born_ireland + born_other_eu + born_other_pre_2004_eu + born_post_2004_eu + born_other,
         density = population_density)
```

 
```{r}

all_elections_polygons <- left_join(all_elections1 %>% st_drop_geometry(), 
                            constituency_polygons, by = c("ons_const_id" = "pcon19cd")) %>% 
  st_as_sf() %>% 
  st_simplify(dTolerance = 1000)

coords <- st_centroid(all_elections_polygons$geometry) %>%
  st_coordinates()

```

```{r}

pcagw.df <- as.data.frame(cbind(all_elections1$con_15, PC1gw, PC2gw, all_elections_polygons$geometry)) %>% 
  st_as_sf()
colnames(pcagw.df) <- c("con_15", "PC1gw", "PC2gw", "geometry")
str(pcagw.df)

# now the GWR model with GWPCA components
GWRbandwidth.gwpca <- gwr.sel(con_15 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, adapt=T)

GWRbandwidth.gwpca

#run the gwr model
gwr.model.gwpca = gwr(con_15 ~ PC1gw + PC2gw, 
                        data=pcagw.df, coords=coords, 
                adapt=GWRbandwidth.gwpca, hatmatrix=TRUE, se.fit=TRUE) 

# examine first two components
head(gwr.model.gwpca$SDF$PC1gw)
head(gwr.model.gwpca$SDF$PC2gw)

# before loop, define vectors
coef_low_qual_gwpca <- vector()
coef_over65_gwpca <- vector()
coef_student_gwpca <- vector()
coef_deprived_gwpca <- vector()
coef_density_gwpca <- vector()
coef_leave_EU_gwpca <- vector()
coef_health_very_bad_gwpca <- vector()
coef_house_owned_gwpca <- vector()
coef_household_one_person_gwpca <- vector()
coef_ethnicity_white_gwpca <- vector()
coef_unemployed_gwpca <- vector()
coef_born_elsewhere_gwpca <- vector()
coef_marg_gwpca <- vector()

# calculate coefficient for each variable by same technique as before
for (i in 1:571) {
coef_low_qual_gwpca[i] <- as.vector((loadings[i,1,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,1,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_over65_gwpca[i] <- as.vector((loadings[i,2,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,2,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_student_gwpca[i] <- as.vector((loadings[i,3,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,3,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_deprived_gwpca[i] <- as.vector((loadings[i,4,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,4,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_density_gwpca[i] <- as.vector((loadings[i,5,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,5,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_leave_EU_gwpca[i] <- as.vector((loadings[i,6,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,6,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_health_very_bad_gwpca[i] <- as.vector((loadings[i,7,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,7,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_house_owned_gwpca[i] <- as.vector((loadings[i,8,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,8,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_household_one_person_gwpca[i] <- as.vector((loadings[i,9,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,9,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_ethnicity_white_gwpca[i] <- as.vector((loadings[i,10,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,10,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_unemployed_gwpca[i] <- as.vector((loadings[i,11,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,11,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_born_elsewhere_gwpca[i] <- as.vector((loadings[i,12,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,12,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
coef_marg_gwpca[i] <- as.vector((loadings[i,13,1] * as.numeric(gwr.model.gwpca$SDF$PC1gw[i])) + 
  (loadings[i,13,2] * as.numeric(gwr.model.gwpca$SDF$PC2gw[i])))
}

# bind into a table
gwr_gwpca_table <- as.data.frame(cbind(coef_low_qual_gwpca, coef_over65_gwpca, coef_student_gwpca, coef_deprived_gwpca,
               coef_density_gwpca, coef_leave_EU_gwpca, coef_health_very_bad_gwpca, coef_house_owned_gwpca, 
               coef_household_one_person_gwpca, coef_ethnicity_white_gwpca, 
               coef_unemployed_gwpca, coef_born_elsewhere_gwpca, coef_marg_gwpca))

# insert into all_elections1 with polygons
all_elections1 <- cbind(all_elections1, gwr_gwpca_table) %>% 
  st_drop_geometry() %>% 
  cbind(all_elections_polygons$geometry) %>% 
  st_as_sf()
  

```


```{r, fig.height=6, fig.width=12}


# coefficient value in each consitituency

p_low_qual_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_low_qual_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_over65_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_over65_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_student_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_student_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_deprived_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_deprived_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_density_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_density_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_leave_EU_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_leave_EU_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_health_very_bad_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_health_very_bad_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_house_owned_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_house_owned_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_household_one_person_15tot <- ggplot(all_elections1) + 
  geom_sf(aes(fill=coef_household_one_person_gwpca)) + 
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_ethnicity_white_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_ethnicity_white_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_unemployed_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_unemployed_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_born_elsewhere_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_born_elsewhere_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)

p_marg_15tot <- ggplot(all_elections1) + geom_sf(aes(fill=coef_marg_gwpca)) +
  coord_sf(datum = NA) +  
  theme_light() + 
  scale_fill_gradient2(low="red",high="blue", midpoint = 0)


```

### Low Qualifications

```{r, fig.height=12, fig.width=12}


(p_low_qual_19change + labs(title="Cons.Change 2019/17")) / 
  (p_low_qual_17change + labs(title="Cons.Change 2017/15")) | 
  (p_low_qual_19tot + labs(title="Cons.Total 2019")) / 
  (p_low_qual_17tot + labs(title="Cons.Total 2017")) / 
  (p_low_qual_15tot + labs(title="Cons.Total 2015"))

```

### Over 65

```{r, fig.height=12, fig.width=12}

(p_over65_19change + labs(title="Cons.Change 2019/17")) / 
  (p_over65_17change + labs(title="Cons.Change 2017/15")) | 
  (p_over65_19tot + labs(title="Cons.Total 2019")) / 
  (p_over65_17tot + labs(title="Cons.Total 2017")) / 
  (p_over65_15tot + labs(title="Cons.Total 2015"))

```

### Student

```{r, fig.height=12, fig.width=12}

(p_student_19change + labs(title="Cons.Change 2019/17")) / 
  (p_student_17change + labs(title="Cons.Change 2017/15")) | 
  (p_student_19tot + labs(title="Cons.Total 2019")) /
  (p_student_17tot + labs(title="Cons.Total 2017")) / 
  (p_student_15tot + labs(title="Cons.Total 2015"))

```

### Deprived

```{r, fig.height=12, fig.width=12}

(p_deprived_19change + labs(title="Cons.Change 2019/17")) / 
  (p_deprived_17change + labs(title="Cons.Change 2017/15")) | 
  (p_deprived_19tot + labs(title="Cons.Total 2019")) /
  (p_deprived_17tot + labs(title="Cons.Total 2017")) / 
  (p_deprived_15tot + labs(title="Cons.Total 2015"))
```

### Density

```{r, fig.height=12, fig.width=12}

(p_density_19change + labs(title="Cons.Change 2019/17")) / 
  (p_density_17change + labs(title="Cons.Change 2017/15")) | 
  (p_density_19tot + labs(title="Cons.Total 2019")) /
  (p_density_17tot + labs(title="Cons.Total 2017")) / 
  (p_density_15tot + labs(title="Cons.Total 2015"))

```

### Leave EU

```{r, fig.height=12, fig.width=12}

(p_leave_EU_19change + labs(title="Cons.Change 2019/17")) / 
  (p_leave_EU_17change + labs(title="Cons.Change 2017/15")) | 
  (p_leave_EU_19tot + labs(title="Cons.Total 2019")) /
  (p_leave_EU_17tot + labs(title="Cons.Total 2017")) / 
  (p_leave_EU_15tot + labs(title="Cons.Total 2015"))

```

### Health Very Bad

```{r, fig.height=12, fig.width=12}

(p_health_very_bad_19change + labs(title="Cons.Change 2019/17")) / 
  (p_health_very_bad_17change + labs(title="Cons.Change 2017/15")) | 
  (p_health_very_bad_19tot + labs(title="Cons.Total 2019")) /
  (p_health_very_bad_17tot + labs(title="Cons.Total 2017")) /
  (p_health_very_bad_15tot + labs(title="Cons.Total 2015"))

```

### House Owned

```{r, fig.height=12, fig.width=12}

(p_house_owned_19change + labs(title="Cons.Change 2019/17")) / 
  (p_house_owned_17change + labs(title="Cons.Change 2017/15")) | 
  (p_house_owned_19tot + labs(title="Cons.Total 2019")) /
  (p_house_owned_17tot + labs(title="Cons.Total 2017")) /
  (p_house_owned_15tot + labs(title="Cons.Total 2015"))

```

### Household One Person

```{r, fig.height=12, fig.width=12}

(p_household_one_person_19change + labs(title="Cons.Change 2019/17")) / 
  (p_household_one_person_17change + labs(title="Cons.Change 2017/15")) | 
  (p_household_one_person_19tot + labs(title="Cons.Total 2019")) /
  (p_household_one_person_17tot + labs(title="Cons.Total 2017")) / 
  (p_household_one_person_15tot + labs(title="Cons.Total 2015"))

```

### Ethnicity White

```{r, fig.height=12, fig.width=12}

(p_ethnicity_white_19change + labs(title="Cons.Change 2019/17")) / 
  (p_ethnicity_white_17change + labs(title="Cons.Change 2017/15")) | 
  (p_ethnicity_white_19tot + labs(title="Cons.Total 2019")) /
  (p_ethnicity_white_17tot + labs(title="Cons.Total 2017")) / 
  (p_ethnicity_white_15tot + labs(title="Cons.Total 2015"))

```

### Unemployed

```{r, fig.height=12, fig.width=12}

(p_unemployed_19change + labs(title="Cons.Change 2019/17")) / 
  (p_unemployed_17change + labs(title="Cons.Change 2017/15")) | 
  (p_unemployed_19tot + labs(title="Cons.Total 2019")) /
  (p_unemployed_17tot + labs(title="Cons.Total 2017")) / 
  (p_unemployed_15tot + labs(title="Cons.Total 2015"))

```

### Born Elsewhere

```{r, fig.height=12, fig.width=12}

(p_born_elsewhere_19change + labs(title="Cons.Change 2019/17")) / 
  (p_born_elsewhere_17change + labs(title="Cons.Change 2017/15")) | 
  (p_born_elsewhere_19tot + labs(title="Cons.Total 2019")) /
  (p_born_elsewhere_17tot + labs(title="Cons.Total 2017")) / 
  (p_born_elsewhere_15tot + labs(title="Cons.Total 2015"))

```

### Marginality

```{r, fig.height=12, fig.width=12}

(p_marg_19change + labs(title="Cons.Change 2019/17")) / 
  (p_marg_17change + labs(title="Cons.Change 2017/15")) | 
  (p_marg_19tot + labs(title="Cons.Total 2019")) /
  (p_marg_17tot + labs(title="Cons.Total 2017")) / 
  (p_marg_15tot + labs(title="Cons.Total 2015"))


```

